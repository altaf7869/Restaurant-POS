<div class="container mt-4">
  <div class="card shadow-lg rounded-4 border-0">
    
    <!-- Header -->
    <div class="card-header bg-primary text-white d-flex flex-column flex-md-row justify-content-between align-items-md-center">
      <h4 class="mb-2 mb-md-0"><i class="bi bi-journal-check me-2"></i>Orders History</h4>
      <div class="d-flex gap-2 mt-2 mt-md-0">
        <span class="badge bg-light text-dark">Total: {{ totalOrdersCount }}</span>
        <span class="badge bg-success">Today: {{ todaysOrdersCount }}</span>
      </div>
    </div>

    <div class="card-body d-flex flex-column">

      <!-- Filters -->
      <form class="row g-3 mb-4 align-items-end" (ngSubmit)="applyFilter()">
        <div class="col-12 col-md-4">
          <label class="form-label fw-semibold">Start Date</label>
          <input type="date" class="form-control" [(ngModel)]="filter.startDate" name="startDate">
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label fw-semibold">End Date</label>
          <input type="date" class="form-control" [(ngModel)]="filter.endDate" name="endDate">
        </div>
        <div class="col-12 col-md-4 d-grid">
          <button class="btn btn-primary fw-bold">
            <i class="bi bi-funnel"></i> Apply Filter
          </button>
        </div>
      </form>

      <!-- Export Buttons -->
      <div class="d-flex justify-content-end mb-3 gap-2 flex-wrap">
        <button class="btn btn-success fw-bold" (click)="downloadCSV()">
          <i class="bi bi-filetype-csv"></i> CSV
        </button>
        <button class="btn btn-secondary fw-bold" (click)="downloadExcel()">
          <i class="bi bi-file-earmark-excel"></i> Excel
        </button>
      </div>

      <!-- Scrollable Orders Table -->
      <div class="table-responsive flex-grow-1 overflow-auto">
        <table class="table table-hover table-bordered align-middle text-center mb-0">
          <thead class="table-dark sticky-top">
            <tr>
              <th>#</th>
              <th>Table</th>
              <th>Total</th>
              <th>Status</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let o of pagedOrders; let i = index">
              <td>{{ o.Id }}</td>
              <td>{{ o.TableId }}</td>
              <td>{{ getFinalTotal(o) | currency:'INR' }}</td>
              <td>
                <span class="badge px-3 py-2"
                      [ngClass]="{
                        'bg-success': o.Status?.toLowerCase() === 'paid',
                        'bg-warning text-dark': o.Status?.toLowerCase() === 'pending',
                        'bg-danger': o.Status?.toLowerCase() === 'cancelled'
                      }">
                  {{ o.Status }}
                </span>
              </td>
              <td>{{ o.CreatedAt | date:'dd-MMM-yyyy hh:mm a' }}</td>
              <td>
                <button class="btn btn-info btn-sm" (click)="viewItems(o)">
                  <i class="bi bi-eye"></i> View
                </button>
              </td>
            </tr>
            <tr *ngIf="filteredOrders.length === 0">
              <td colspan="6" class="text-center text-muted py-3">
                <i class="bi bi-clipboard-x me-2"></i>No orders found for selected dates
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <nav *ngIf="totalPages > 1" class="mt-3">
        <ul class="pagination justify-content-center mb-0 flex-wrap">
          <li class="page-item" [class.disabled]="currentPage === 1">
            <a class="page-link" (click)="prevPage()">Previous</a>
          </li>
          <li class="page-item" *ngFor="let p of paginationRange" [class.active]="p === currentPage" [class.disabled]="p === '...'">
            <a class="page-link" *ngIf="p !== '...'" (click)="goToPage(p)">{{ p }}</a>
            <span class="page-link" *ngIf="p === '...'">...</span>
          </li>
          <li class="page-item" [class.disabled]="currentPage === totalPages">
            <a class="page-link" (click)="nextPage()">Next</a>
          </li>
        </ul>
      </nav>

    </div>
  </div>
</div>

<!-- Order Items Modal -->
<div class="modal fade" id="itemsModal" tabindex="-1" aria-labelledby="itemsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-4">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Invoice - #{{ selectedOrder?.Id }}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">

        <!-- Order Info -->
        <div class="mb-3">
          <strong>Table:</strong> {{ selectedOrder?.TableId }} <br>
          <strong>Date:</strong> {{ selectedOrder?.CreatedAt | date:'dd-MMM-yyyy, hh:mm a' }} <br>
          <strong>Status:</strong>
          <span class="badge"
                [ngClass]="{
                  'bg-success': selectedOrder?.Status?.toLowerCase() === 'paid',
                  'bg-warning text-dark': selectedOrder?.Status?.toLowerCase() === 'pending',
                  'bg-danger': selectedOrder?.Status?.toLowerCase() === 'cancelled'
                }">
            {{ selectedOrder?.Status }}
          </span>
        </div>

        <!-- Items Table -->
        <div class="table-responsive">
          <table class="table table-bordered table-striped">
            <thead class="table-light">
              <tr>
                <th>#</th>
                <th>Item</th>
                <th>Qty</th>
                <th>Price</th>
                <th>Subtotal</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of selectedOrderItems; let i = index">
                <td>{{ i + 1 }}</td>
                <td>{{ item.Name }}</td>
                <td>{{ item.qty }}</td>
                <td>₹ {{ item.Price | number:'1.0-0' }}</td>
                <td>₹ {{ (item.Price * item.qty) | number:'1.0-0' }}</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Totals -->
        <div *ngIf="selectedOrder" class="d-flex flex-column align-items-end gap-1 fw-bold fs-5 mt-3">
          <div>Subtotal: ₹ {{ calculateSubtotal(selectedOrder) | number:'1.0-0' }}</div>
          <div *ngIf="selectedOrder?.DiscountAmount">
            Discount: -₹ {{ selectedOrder?.DiscountAmount | number:'1.0-0' }}
          </div>
          <div *ngIf="selectedOrder?.GST">
            GST ({{ selectedOrder?.GST }}%): ₹ {{ calculateGST(selectedOrder) | number:'1.0-0' }}
          </div>
          <div class="mt-2 border-top pt-2">
            Total: ₹ {{ getFinalTotal(selectedOrder) | number:'1.0-0' }}
          </div>
        </div>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
