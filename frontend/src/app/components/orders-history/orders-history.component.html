<div class="container mt-5">
  <h3 class="text-center text-primary fw-bold mb-4">Orders History</h3>

  <!-- 🔍 Date Filter -->
  <div class="row g-3 mb-4 align-items-end">
    <div class="col-md-4">
      <label class="form-label fw-semibold">Start Date</label>
      <input type="date" class="form-control" [(ngModel)]="filter.startDate">
    </div>
    <div class="col-md-4">
      <label class="form-label fw-semibold">End Date</label>
      <input type="date" class="form-control" [(ngModel)]="filter.endDate">
    </div>
    <div class="col-md-4 d-grid">
      <button class="btn btn-primary fw-bold" (click)="applyFilter()">
        <i class="bi bi-funnel"></i> Filter
      </button>
    </div>
  </div>

  <!-- 📥 Download Buttons -->
  <div class="d-flex justify-content-end mb-3 gap-2">
    <button class="btn btn-success fw-bold" (click)="downloadCSV()">
      <i class="bi bi-filetype-csv"></i> Download CSV
    </button>
    <button class="btn btn-secondary fw-bold" (click)="downloadExcel()">
      <i class="bi bi-file-earmark-excel"></i> Download Excel
    </button>
  </div>

  <!-- 📋 Orders Table -->
  <div class="table-responsive shadow-sm rounded-4">
    <table class="table table-striped table-hover align-middle text-center mb-0">
      <thead class="table-light">
        <tr>
          <th>Order ID</th>
          <th>Table</th>
          <th>Total</th>
          <th>Status</th>
          <th>Date</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <!-- ✅ Orders List -->
        <tr *ngFor="let o of pagedOrders">
          <td>{{ o.Id }}</td>
          <td>{{ o.TableId }}</td>
          <td>{{ getFinalTotal(o) | currency:'INR' }}</td>
          <td>
            <span class="badge"
              [ngClass]="{
                'bg-success': o.Status?.toLowerCase() === 'paid',
                'bg-warning text-dark': o.Status?.toLowerCase() === 'pending',
                'bg-danger': o.Status?.toLowerCase() === 'cancelled'
              }">
              {{ o.Status }}
            </span>
          </td>
          <td>{{ o.CreatedAt | date:'dd-MMM-yyyy' }}</td>
          <td>
            <button class="btn btn-info btn-sm" (click)="viewItems(o)">
              <i class="bi bi-eye"></i> View Items
            </button>
          </td>
        </tr>

        <!-- ❌ No Orders -->
        <tr *ngIf="filteredOrders.length === 0">
          <td colspan="6" class="text-center text-muted py-3">
            No orders found for selected dates
          </td>
        </tr>
      </tbody>
    </table>

    <!-- 📄 Pagination -->
  <nav *ngIf="totalPages > 1" aria-label="Orders pagination">
  <ul class="pagination justify-content-center mt-3">
    <li class="page-item" [class.disabled]="currentPage === 1">
      <a class="page-link" (click)="prevPage()">Previous</a>
    </li>

    <li class="page-item"
        *ngFor="let p of paginationRange"
        [class.active]="p === currentPage"
        [class.disabled]="p === '...'">
      <!-- Only call goToPage if p is a number -->
      <a class="page-link" *ngIf="p !== '...'" (click)="goToPage(p)">{{ p }}</a>
      <span class="page-link" *ngIf="p === '...'">...</span>
    </li>

    <li class="page-item" [class.disabled]="currentPage === totalPages">
      <a class="page-link" (click)="nextPage()">Next</a>
    </li>
  </ul>
</nav>


  </div>

  <!-- 🧾 Bill Modal -->
  <div class="modal fade" id="itemsModal" tabindex="-1" aria-labelledby="itemsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content border-0 shadow">
        <!-- Header -->
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="itemsModalLabel">
            Order Invoice - ID: {{ selectedOrder?.Id }}
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <!-- Body -->
        <div class="modal-body p-4">
          <!-- Order Info -->
          <div class="mb-3">
            <strong>Table:</strong> {{ selectedOrder?.TableId }} <br>
            <strong>Date:</strong> {{ selectedOrder?.CreatedAt | date:'dd-MMM-yyyy, hh:mm a' }} <br>
            <strong>Status:</strong>
            <span class="badge"
              [ngClass]="{
                'bg-success': selectedOrder?.Status?.toLowerCase() === 'paid',
                'bg-warning text-dark': selectedOrder?.Status?.toLowerCase() === 'pending',
                'bg-danger': selectedOrder?.Status?.toLowerCase() === 'cancelled'
              }">
              {{ selectedOrder?.Status }}
            </span>
          </div>

          <!-- Itemized Table -->
          <table class="table table-bordered table-striped mb-3">
            <thead class="table-light">
              <tr>
                <th>#</th>
                <th>Item Name</th>
                <th>Qty</th>
                <th>Price (₹)</th>
                <th>Subtotal (₹)</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of selectedOrderItems; let i = index">
                <td>{{ i + 1 }}</td>
                <td>{{ item.Name }}</td>
                <td>{{ item.qty }}</td>
                <td>{{ item.Price | number:'1.0-0' }}</td>
                <td>{{ (item.Price * item.qty) | number:'1.0-0' }}</td>
              </tr>
            </tbody>
          </table>

          <!-- Totals -->
          <!-- Totals -->
<div *ngIf="selectedOrder" class="d-flex flex-column align-items-end gap-1 fw-bold fs-5">
  <div>Subtotal: ₹ {{ calculateSubtotal(selectedOrder) | number:'1.0-0' }}</div>
  <div *ngIf="selectedOrder?.DiscountAmount">
    Discount: ₹ {{ selectedOrder?.DiscountAmount | number:'1.0-0' }}
  </div>
  <div *ngIf="selectedOrder?.GST">
    GST ({{ selectedOrder?.GST }}%): ₹ {{ calculateGST(selectedOrder) | number:'1.0-0' }}
  </div>
  <div class="mt-2 border-top pt-2">
    Total: ₹ {{ getFinalTotal(selectedOrder) | number:'1.0-0' }}
  </div>
</div>

        </div>

        <!-- Footer -->
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
